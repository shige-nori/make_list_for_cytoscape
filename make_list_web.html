<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .card h3 {
            color: #555;
            margin-bottom: 15px;
            margin-top: 20px;
            font-size: 1.1em;
        }

        .file-input-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .file-input-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .file-input-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
        }

        .file-input-area i {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-input-area p {
            color: #666;
            font-size: 1.1em;
        }

        .file-input-area .file-name {
            color: #667eea;
            font-weight: bold;
            margin-top: 10px;
        }

        #fileInput {
            display: none;
        }

        .btn {
            display: inline-block;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: bold;
            text-transform: uppercase;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }

        .btn-folder {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            padding: 12px 25px;
            font-size: 1em;
        }

        .btn-folder:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 175, 25, 0.4);
        }

        .btn-folder:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .save-all-section {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border-radius: 10px;
            border: 1px solid #f5af19;
            text-align: center;
        }

        .save-all-section p {
            margin-bottom: 10px;
            color: #856404;
            font-size: 0.9em;
        }

        .save-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .save-status.success {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .save-status.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a8a8a8 0%, #6c757d 100%);
            color: white;
            padding: 10px 20px;
            font-size: 0.9em;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(108, 117, 125, 0.4);
        }

        .btn-add {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px 20px;
            font-size: 0.9em;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
        }

        .btn-add:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            color: white;
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(238, 90, 90, 0.4);
        }

        .btn-danger:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-remove {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: bold;
            min-width: 45px;
        }

        .btn-remove:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
        }

        .btn-remove:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .card-header h2 {
            margin: 0;
            padding: 0;
            border: none;
        }

        .actions {
            text-align: center;
            margin-top: 20px;
        }

        .log-area {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            color: #00ff00;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-area .log-entry {
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-area .log-entry.error {
            color: #ff6b6b;
        }

        .log-area .log-entry.success {
            color: #51cf66;
        }

        .log-area .log-entry.warning {
            color: #fcc419;
        }

        .log-area .log-entry.info {
            color: #74c0fc;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .result-item {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e0e5ff;
        }

        .result-item h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .result-item .count {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .result-item .unit {
            color: #666;
            font-size: 0.9em;
        }

        .download-section {
            margin-top: 20px;
        }

        .preview-section {
            margin-top: 20px;
        }

        .preview-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .preview-tab {
            padding: 10px 20px;
            background: #e0e5ff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #667eea;
        }

        .preview-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .preview-table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e0e5ff;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .preview-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .preview-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        .preview-table tr:nth-child(even) {
            background: #f8f9ff;
        }

        .preview-table tr:hover {
            background: #e8ebff;
        }

        .mapping-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 1px solid #e0e5ff;
        }

        .mapping-section h3 {
            color: #667eea;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .mapping-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .mapping-item label {
            font-weight: bold;
            color: #333;
            font-size: 0.95em;
        }

        .mapping-item select {
            padding: 10px;
            border: 2px solid #e0e5ff;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
            cursor: pointer;
        }

        .mapping-item select:focus {
            outline: none;
            border-color: #667eea;
        }

        .mapping-item select:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .add-btn-container {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .add-btn-container .btn-remove {
            position: absolute;
            right: 0;
        }

        .hidden {
            display: none;
        }

        .disabled-section {
            opacity: 0.5;
            pointer-events: none;
        }

        .info-text {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .card {
                padding: 20px;
            }

            .file-input-area {
                padding: 30px 20px;
            }

            .mapping-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”— ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒ„ãƒ¼ãƒ«</h1>
            <p>Excel/CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™</p>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚«ãƒ¼ãƒ‰ -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ“‚ ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h2>
                <button class="btn btn-danger" id="clearBtn">ğŸ”„ ã‚¯ãƒªã‚¢</button>
            </div>
            <div class="file-input-area" id="dropZone">
                <div id="fileIcon">ğŸ“„</div>
                <p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                <p style="font-size: 0.9em; color: #888; margin-top: 10px;">å¯¾å¿œå½¢å¼: Excel (.xlsx) / CSV (.csv)</p>
                <p class="file-name" id="selectedFileName"></p>
                <input type="file" id="fileInput" accept=".xlsx,.csv">
            </div>
        </div>

        <!-- ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šã‚«ãƒ¼ãƒ‰ -->
        <div class="card" id="mappingCard">
            <h2>âš™ï¸ ã‚¹ãƒ†ãƒƒãƒ—2: ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®š</h2>
            
            <div id="mappingDisabledMessage" class="info-text">
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ã‚«ãƒ©ãƒ ã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
            </div>

            <!-- ãƒãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚° -->
            <div class="mapping-section" id="nodeMappingSection">
                <h3>ğŸ”µ ãƒãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                    ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒãƒ¼ãƒ‰ï¼ˆé ‚ç‚¹ï¼‰ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚«ãƒ©ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ãƒãƒ¼ãƒ‰é–“ã¯ã‚¨ãƒƒã‚¸ã§æ¥ç¶šã•ã‚Œã¾ã™ã€‚
                </p>
                <div class="mapping-grid" id="nodeMappingGrid">
                    <!-- ãƒãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°é …ç›®ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
                <div class="add-btn-container">
                    <button class="btn btn-add" id="addNodeBtn" disabled>â• ãƒãƒ¼ãƒ‰ã‚’æ›´ã«è¿½åŠ </button>
                    <button class="btn btn-remove" id="removeNodeBtn" disabled>â–</button>
                </div>
            </div>

            <!-- å±æ€§å€¤ãƒãƒƒãƒ”ãƒ³ã‚° -->
            <div class="mapping-section" id="attrMappingSection">
                <h3>ğŸ·ï¸ å±æ€§å€¤ãƒãƒƒãƒ”ãƒ³ã‚°</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                    ãƒãƒ¼ãƒ‰ã‚„ã‚¨ãƒƒã‚¸ã«ä»˜ä¸ã™ã‚‹å±æ€§ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚«ãƒ©ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
                </p>
                <div class="mapping-grid" id="attrMappingGrid">
                    <!-- å±æ€§ãƒãƒƒãƒ”ãƒ³ã‚°é …ç›®ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
                <div class="add-btn-container">
                    <button class="btn btn-add" id="addAttrBtn" disabled>â• å±æ€§å€¤ã‚’æ›´ã«è¿½åŠ </button>
                    <button class="btn btn-remove" id="removeAttrBtn" disabled>â–</button>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="processBtn" disabled>ğŸš€ å‡¦ç†ã‚’å®Ÿè¡Œ</button>
            </div>
        </div>

        <!-- å‡¦ç†ãƒ­ã‚°ã‚«ãƒ¼ãƒ‰ -->
        <div class="card" id="logCard">
            <h2>ğŸ“‹ å‡¦ç†ãƒ­ã‚°</h2>
            <div class="log-area" id="logArea">
                <div class="log-entry info">å‡¦ç†ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„...</div>
            </div>
        </div>

        <!-- çµæœã‚«ãƒ¼ãƒ‰ -->
        <div class="card hidden" id="resultsCard">
            <h2>ğŸ“Š å‡¦ç†çµæœ</h2>
            <div class="results-grid" id="resultsGrid">
                <!-- çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div class="download-section">
                <h3 style="margin-bottom: 15px; color: #333;">ğŸ’¾ ä¿å­˜</h3>
                
                <div class="save-all-section">
                    <p>ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ã€ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬ä¿å­˜ã§ãã¾ã™</p>
                    <button class="btn btn-folder" id="saveAllBtn" onclick="saveAllToFolder()">
                        ğŸ“‚ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ä¸€æ‹¬ä¿å­˜
                    </button>
                    <div class="save-status" id="saveStatus"></div>
                </div>
            </div>

            <div class="preview-section">
                <h3 style="margin-bottom: 15px; color: #333;">ğŸ‘ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div class="preview-tabs" id="previewTabs">
                    <!-- ã‚¿ãƒ–ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                <div class="preview-table-container" id="previewTableContainer">
                    <table class="preview-table" id="previewTable">
                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let loadedData = null;
        let fileHeaders = [];
        let generatedFiles = {};
        let nodeCount = 4;  // åˆæœŸãƒãƒ¼ãƒ‰æ•°
        let attrCount = 4;  // åˆæœŸå±æ€§æ•°

        // DOMè¦ç´ 
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const selectedFileName = document.getElementById('selectedFileName');
        const processBtn = document.getElementById('processBtn');
        const logArea = document.getElementById('logArea');
        const resultsCard = document.getElementById('resultsCard');
        const resultsGrid = document.getElementById('resultsGrid');
        const previewTabs = document.getElementById('previewTabs');
        const previewTable = document.getElementById('previewTable');
        const nodeMappingGrid = document.getElementById('nodeMappingGrid');
        const attrMappingGrid = document.getElementById('attrMappingGrid');
        const addNodeBtn = document.getElementById('addNodeBtn');
        const addAttrBtn = document.getElementById('addAttrBtn');
        const removeNodeBtn = document.getElementById('removeNodeBtn');
        const removeAttrBtn = document.getElementById('removeAttrBtn');
        const mappingDisabledMessage = document.getElementById('mappingDisabledMessage');
        const clearBtn = document.getElementById('clearBtn');

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateRemoveButtonStates() {
            // ãƒãƒ¼ãƒ‰å‰Šé™¤ãƒœã‚¿ãƒ³ï¼šåˆæœŸã®4ã¤ã‚ˆã‚Šå¤šã„å ´åˆã®ã¿æœ‰åŠ¹
            removeNodeBtn.disabled = nodeCount <= 4 || !loadedData;
            // å±æ€§å‰Šé™¤ãƒœã‚¿ãƒ³ï¼šåˆæœŸã®4ã¤ã‚ˆã‚Šå¤šã„å ´åˆã®ã¿æœ‰åŠ¹
            removeAttrBtn.disabled = attrCount <= 4 || !loadedData;
        }

        // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼šåˆæœŸçŠ¶æ…‹ã«æˆ»ã™
        clearBtn.addEventListener('click', () => {
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            loadedData = null;
            fileHeaders = [];
            generatedFiles = {};
            nodeCount = 4;
            attrCount = 4;

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            fileInput.value = '';
            selectedFileName.textContent = '';

            // ãƒãƒƒãƒ”ãƒ³ã‚°é …ç›®ã‚’åˆæœŸåŒ–
            initMappingItems();

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            processBtn.disabled = true;
            addNodeBtn.disabled = true;
            addAttrBtn.disabled = true;
            removeNodeBtn.disabled = true;
            removeAttrBtn.disabled = true;

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†è¡¨ç¤º
            mappingDisabledMessage.classList.remove('hidden');

            // çµæœã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º
            resultsCard.classList.add('hidden');
            resultsGrid.innerHTML = '';
            previewTabs.innerHTML = '';
            previewTable.innerHTML = '';

            // ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
            clearLog();
            log('åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'info');
        });

        // åˆæœŸåŒ–ï¼šãƒãƒƒãƒ”ãƒ³ã‚°é …ç›®ã‚’ä½œæˆ
        function initMappingItems() {
            // ãƒãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒãƒ¼ãƒ‰1ã€œ4ï¼‰
            nodeMappingGrid.innerHTML = '';
            for (let i = 1; i <= nodeCount; i++) {
                addNodeMappingItem(i);
            }

            // å±æ€§ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå±æ€§1ã€œ4ï¼‰
            attrMappingGrid.innerHTML = '';
            for (let i = 1; i <= attrCount; i++) {
                addAttrMappingItem(i);
            }
        }

        // ãƒãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°é …ç›®ã‚’è¿½åŠ 
        function addNodeMappingItem(index) {
            const item = document.createElement('div');
            item.className = 'mapping-item';
            item.innerHTML = `
                <label for="node${index}">ãƒãƒ¼ãƒ‰${index}:</label>
                <select id="node${index}" disabled onchange="updateAllSelectOptions()">
                    <option value="">-- ã‚«ãƒ©ãƒ ã‚’é¸æŠ --</option>
                </select>
            `;
            nodeMappingGrid.appendChild(item);
        }

        // å±æ€§ãƒãƒƒãƒ”ãƒ³ã‚°é …ç›®ã‚’è¿½åŠ 
        function addAttrMappingItem(index) {
            const item = document.createElement('div');
            item.className = 'mapping-item';
            item.innerHTML = `
                <label for="attr${index}">å±æ€§${index}:</label>
                <select id="attr${index}" disabled onchange="updateAllSelectOptions()">
                    <option value="">-- ã‚«ãƒ©ãƒ ã‚’é¸æŠ --</option>
                </select>
            `;
            attrMappingGrid.appendChild(item);
        }

        // é¸æŠæ¸ˆã¿ã®ã‚«ãƒ©ãƒ ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getSelectedColumns() {
            const selected = new Set();
            
            // ãƒãƒ¼ãƒ‰ã®é¸æŠå€¤ã‚’å–å¾—
            for (let i = 1; i <= nodeCount; i++) {
                const select = document.getElementById(`node${i}`);
                if (select && select.value) {
                    selected.add(select.value);
                }
            }
            
            // å±æ€§ã®é¸æŠå€¤ã‚’å–å¾—
            for (let i = 1; i <= attrCount; i++) {
                const select = document.getElementById(`attr${i}`);
                if (select && select.value) {
                    selected.add(select.value);
                }
            }
            
            return selected;
        }

        // å…¨ã¦ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ï¼ˆé¸æŠæ¸ˆã¿é …ç›®ã‚’é™¤å¤–ï¼‰
        function updateAllSelectOptions() {
            const selectedColumns = getSelectedColumns();
            
            // ãƒãƒ¼ãƒ‰ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            for (let i = 1; i <= nodeCount; i++) {
                const select = document.getElementById(`node${i}`);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- ã‚«ãƒ©ãƒ ã‚’é¸æŠ --</option>';
                    fileHeaders.forEach(header => {
                        // ç¾åœ¨ã®é¸æŠå€¤ã¾ãŸã¯æœªé¸æŠã®ã‚«ãƒ©ãƒ ã®ã¿è¡¨ç¤º
                        if (!selectedColumns.has(header) || header === currentValue) {
                            const option = document.createElement('option');
                            option.value = header;
                            option.textContent = header;
                            select.appendChild(option);
                        }
                    });
                    select.disabled = false;
                    if (currentValue && fileHeaders.includes(currentValue)) {
                        select.value = currentValue;
                    }
                }
            }

            // å±æ€§ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            for (let i = 1; i <= attrCount; i++) {
                const select = document.getElementById(`attr${i}`);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- ã‚«ãƒ©ãƒ ã‚’é¸æŠ --</option>';
                    fileHeaders.forEach(header => {
                        // ç¾åœ¨ã®é¸æŠå€¤ã¾ãŸã¯æœªé¸æŠã®ã‚«ãƒ©ãƒ ã®ã¿è¡¨ç¤º
                        if (!selectedColumns.has(header) || header === currentValue) {
                            const option = document.createElement('option');
                            option.value = header;
                            option.textContent = header;
                            select.appendChild(option);
                        }
                    });
                    select.disabled = false;
                    if (currentValue && fileHeaders.includes(currentValue)) {
                        select.value = currentValue;
                    }
                }
            }
        }

        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ã‚«ãƒ©ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
        function populateSelectOptions() {
            updateAllSelectOptions();
        }

        // ãƒãƒ¼ãƒ‰è¿½åŠ ãƒœã‚¿ãƒ³
        addNodeBtn.addEventListener('click', () => {
            const startIndex = nodeCount + 1;
            for (let i = 0; i < 4; i++) {
                nodeCount++;
                addNodeMappingItem(nodeCount);
            }
            // å…¨ã¦ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ï¼ˆé¸æŠæ¸ˆã¿é …ç›®ã‚’é™¤å¤–ï¼‰
            updateAllSelectOptions();
            log(`ãƒãƒ¼ãƒ‰${startIndex}ã€œ${nodeCount} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'info');
            updateRemoveButtonStates();
        });

        // ãƒãƒ¼ãƒ‰å‰Šé™¤ãƒœã‚¿ãƒ³
        removeNodeBtn.addEventListener('click', () => {
            if (nodeCount <= 4) return;
            
            const startIndex = nodeCount - 3;
            const endIndex = nodeCount;
            
            // æœ€å¾Œã®4ã¤ã®ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤
            for (let i = 0; i < 4; i++) {
                const lastItem = nodeMappingGrid.lastElementChild;
                if (lastItem) {
                    nodeMappingGrid.removeChild(lastItem);
                    nodeCount--;
                }
            }
            
            // å…¨ã¦ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ï¼ˆå‰Šé™¤ã•ã‚ŒãŸé …ç›®ãŒå†ã³é¸æŠå¯èƒ½ã«ï¼‰
            updateAllSelectOptions();
            log(`ãƒãƒ¼ãƒ‰${startIndex}ã€œ${endIndex} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'info');
            updateRemoveButtonStates();
        });

        // å±æ€§è¿½åŠ ãƒœã‚¿ãƒ³
        addAttrBtn.addEventListener('click', () => {
            const startIndex = attrCount + 1;
            for (let i = 0; i < 4; i++) {
                attrCount++;
                addAttrMappingItem(attrCount);
            }
            // å…¨ã¦ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ï¼ˆé¸æŠæ¸ˆã¿é …ç›®ã‚’é™¤å¤–ï¼‰
            updateAllSelectOptions();
            log(`å±æ€§${startIndex}ã€œ${attrCount} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'info');
            updateRemoveButtonStates();
        });

        // å±æ€§å‰Šé™¤ãƒœã‚¿ãƒ³
        removeAttrBtn.addEventListener('click', () => {
            if (attrCount <= 4) return;
            
            const startIndex = attrCount - 3;
            const endIndex = attrCount;
            
            // æœ€å¾Œã®4ã¤ã®å±æ€§ã‚’å‰Šé™¤
            for (let i = 0; i < 4; i++) {
                const lastItem = attrMappingGrid.lastElementChild;
                if (lastItem) {
                    attrMappingGrid.removeChild(lastItem);
                    attrCount--;
                }
            }
            
            // å…¨ã¦ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ï¼ˆå‰Šé™¤ã•ã‚ŒãŸé …ç›®ãŒå†ã³é¸æŠå¯èƒ½ã«ï¼‰
            updateAllSelectOptions();
            log(`å±æ€§${startIndex}ã€œ${endIndex} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'info');
            updateRemoveButtonStates();
        });

        // åˆæœŸåŒ–å®Ÿè¡Œ
        initMappingItems();

        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ãƒ­ã‚°ã‚¯ãƒªã‚¢é–¢æ•°
        function clearLog() {
            logArea.innerHTML = '';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å‡¦ç†
        function handleFile(file) {
            const validExtensions = ['.xlsx', '.csv'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (!validExtensions.includes(fileExtension)) {
                log('ã‚¨ãƒ©ãƒ¼: å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚Excel (.xlsx) ã¾ãŸã¯ CSV (.csv) ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            selectedFileName.textContent = `é¸æŠä¸­: ${file.name}`;
            log(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã‚’èª­ã¿è¾¼ã¿ä¸­...`, 'info');

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    let data;
                    let workbook;
                    let sheet;
                    
                    if (fileExtension === '.csv') {
                        // CSVå½¢å¼
                        const text = e.target.result;
                        workbook = XLSX.read(text, { type: 'string' });
                    } else {
                        // Excelå½¢å¼ï¼šè¡¨ç¤ºå€¤ã‚’ç›´æ¥å–å¾—ï¼ˆCSVå¤‰æ›ã‚’çµŒç”±ã—ãªã„ï¼‰
                        log('Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­ï¼ˆè¡¨ç¤ºå€¤ã‚’ä½¿ç”¨ï¼‰...', 'info');
                        const arrayBuffer = e.target.result;
                        // cellText: true ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
                        workbook = XLSX.read(arrayBuffer, { 
                            type: 'array', 
                            cellText: true,
                            cellDates: true,
                            cellNF: true,
                            cellStyles: true
                        });
                        log('Excelãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆè¡¨ç¤ºå€¤ã‚’ä½¿ç”¨ï¼‰', 'success');
                    }
                    
                    const sheetName = workbook.SheetNames[0];
                    sheet = workbook.Sheets[sheetName];
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ç›´æ¥å–å¾—ï¼ˆç©ºã‚»ãƒ«ãŒã‚ã£ã¦ã‚‚å…¨ã‚«ãƒ©ãƒ ã‚’å–å¾—ï¼‰
                    const range = XLSX.utils.decode_range(sheet['!ref']);
                    const headers = [];
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                        const cell = sheet[cellAddress];
                        // ã‚»ãƒ«ã®è¡¨ç¤ºå€¤ (.w) ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
                        let headerValue = cell ? (cell.w !== undefined ? cell.w : cell.v) : `Column${col + 1}`;
                        headers.push(String(headerValue));
                    }
                    fileHeaders = headers;
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹éš›ã‚‚è¡¨ç¤ºå€¤ã‚’ä½¿ç”¨
                    data = [];
                    for (let row = range.s.r + 1; row <= range.e.r; row++) {
                        const rowData = {};
                        for (let col = range.s.c; col <= range.e.c; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                            const cell = sheet[cellAddress];
                            const header = headers[col];
                            // ã‚»ãƒ«ã®è¡¨ç¤ºå€¤ (.w) ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
                            let value = cell ? (cell.w !== undefined ? cell.w : cell.v) : '';
                            rowData[header] = String(value !== undefined && value !== null ? value : '');
                        }
                        data.push(rowData);
                    }

                    if (!data || data.length === 0) {
                        log('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                        return;
                    }
                    
                    loadedData = data;
                    log(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${data.length} è¡Œã€${fileHeaders.length} ã‚«ãƒ©ãƒ `, 'success');
                    log(`ã‚«ãƒ©ãƒ : ${fileHeaders.join(', ')}`, 'info');

                    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
                    populateSelectOptions();
                    
                    // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                    processBtn.disabled = false;
                    addNodeBtn.disabled = false;
                    addAttrBtn.disabled = false;
                    
                    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                    updateRemoveButtonStates();
                    
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                    mappingDisabledMessage.classList.add('hidden');

                } catch (error) {
                    log(`ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ - ${error.message}`, 'error');
                    processBtn.disabled = true;
                }
            };

            reader.onerror = () => {
                log('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            };

            if (fileExtension === '.csv') {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // å‡¦ç†å®Ÿè¡Œãƒœã‚¿ãƒ³
        processBtn.addEventListener('click', () => {
            if (!loadedData) {
                log('ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            // é¸æŠã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã‚’å–å¾—
            const selectedNodes = [];
            for (let i = 1; i <= nodeCount; i++) {
                const select = document.getElementById(`node${i}`);
                if (select && select.value) {
                    selectedNodes.push({ index: i, column: select.value });
                }
            }

            if (selectedNodes.length < 2) {
                log('ã‚¨ãƒ©ãƒ¼: å°‘ãªãã¨ã‚‚2ã¤ã®ãƒãƒ¼ãƒ‰ã‚«ãƒ©ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            // é¸æŠã•ã‚ŒãŸå±æ€§ã‚’å–å¾—
            const selectedAttrs = [];
            for (let i = 1; i <= attrCount; i++) {
                const select = document.getElementById(`attr${i}`);
                if (select && select.value) {
                    selectedAttrs.push({ index: i, column: select.value });
                }
            }

            clearLog();
            processData(selectedNodes, selectedAttrs);
        });

        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†é–¢æ•°
        function processData(selectedNodes, selectedAttrs) {
            log('å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
            log(`é¸æŠã•ã‚ŒãŸãƒãƒ¼ãƒ‰: ${selectedNodes.map(n => n.column).join(' â†’ ')}`, 'info');
            log(`é¸æŠã•ã‚ŒãŸå±æ€§: ${selectedAttrs.map(a => a.column).join(', ') || 'ãªã—'}`, 'info');
            generatedFiles = {};

            // ãƒãƒ¼ãƒ‰ã‚«ãƒ©ãƒ åã®ãƒªã‚¹ãƒˆ
            const nodeColumns = selectedNodes.map(n => n.column);
            // å±æ€§ã‚«ãƒ©ãƒ åã®ãƒªã‚¹ãƒˆ
            const attrColumns = selectedAttrs.map(a => a.column);

            // 1. Network.csv ã®ä½œæˆ
            log('å‡¦ç†ä¸­: Networkã‚’ä½œæˆã—ã¦ã„ã¾ã™...', 'info');
            const edgeList = [];

            loadedData.forEach(row => {
                // å±æ€§å€¤ã‚’å–å¾—
                const attrValues = {};
                attrColumns.forEach(col => {
                    attrValues[col] = row[col];
                });

                // é€£ç¶šã™ã‚‹ãƒãƒ¼ãƒ‰é–“ã«ã‚¨ãƒƒã‚¸ã‚’ä½œæˆ
                for (let i = 0; i < nodeColumns.length - 1; i++) {
                    const sourceCol = nodeColumns[i];
                    const targetCol = nodeColumns[i + 1];
                    
                    if (row[sourceCol] && row[targetCol]) {
                        const edge = {
                            Source: row[sourceCol],
                            Target: row[targetCol],
                            ...attrValues
                        };
                        edgeList.push(edge);
                    }
                }
            });

            generatedFiles['Network.csv'] = {
                data: edgeList,
                description: 'å±æ€§ä»˜ãã®ç”Ÿã®ã‚¨ãƒƒã‚¸ãƒªã‚¹ãƒˆ'
            };
            log(`å®Œäº†: Network.csv ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆ${edgeList.length} ã‚¨ãƒƒã‚¸ï¼‰`, 'success');

            // 2. Network with weight.csv ã®ä½œæˆ
            log('å‡¦ç†ä¸­: Network with weightã‚’ä½œæˆã—ã¦ã„ã¾ã™...', 'info');
            const edgeWeightMap = new Map();

            edgeList.forEach(edge => {
                const key = `${edge.Source}|||${edge.Target}`;
                if (!edgeWeightMap.has(key)) {
                    const item = {
                        Source: edge.Source,
                        Target: edge.Target,
                        EdgeWeight: 0
                    };
                    // å„å±æ€§ç”¨ã®é…åˆ—ã‚’ä½œæˆï¼ˆé‡è¤‡ã‚’ä¿æŒï¼‰
                    attrColumns.forEach(col => {
                        item[`${col}_values`] = [];
                    });
                    edgeWeightMap.set(key, item);
                }
                const item = edgeWeightMap.get(key);
                item.EdgeWeight++;
                // å±æ€§å€¤ã‚’è¿½åŠ ï¼ˆé‡è¤‡ã‚’ä¿æŒï¼‰
                attrColumns.forEach(col => {
                    const value = edge[col];
                    if (value === undefined || value === null) {
                        item[`${col}_values`].push(' ');
                    } else if (value === '') {
                        item[`${col}_values`].push(' ');
                    } else {
                        item[`${col}_values`].push(String(value));
                    }
                });
            });

            const edgeWeightList = Array.from(edgeWeightMap.values()).map(item => {
                const result = {
                    Source: item.Source,
                    Target: item.Target,
                    EdgeWeight: item.EdgeWeight
                };
                // é…åˆ—ã‚’æ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆé‡è¤‡ã‚’ä¿æŒï¼‰
                attrColumns.forEach(col => {
                    result[col] = item[`${col}_values`].join('|');
                });
                return result;
            });

            generatedFiles['Network with weight.csv'] = {
                data: edgeWeightList,
                description: 'ã‚¨ãƒƒã‚¸ã®é‡ã¿ä»˜ããƒªã‚¹ãƒˆ'
            };
            log(`å®Œäº†: Network with weight.csv ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆ${edgeWeightList.length} ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¨ãƒƒã‚¸ï¼‰`, 'success');

            // 3. Node.csv ã®ä½œæˆ
            log('å‡¦ç†ä¸­: Nodeã‚’ä½œæˆã—ã¦ã„ã¾ã™...', 'info');
            const nodeAttributeMap = new Map();

            loadedData.forEach(row => {
                nodeColumns.forEach(col => {
                    const node = row[col];
                    if (node) {
                        if (!nodeAttributeMap.has(node)) {
                            const item = {
                                Node: node,
                                count: 0
                            };
                            // å„å±æ€§ç”¨ã®é…åˆ—ã‚’ä½œæˆï¼ˆé‡è¤‡ã‚’ä¿æŒï¼‰
                            attrColumns.forEach(attrCol => {
                                item[`${attrCol}_values`] = [];
                            });
                            nodeAttributeMap.set(node, item);
                        }
                        const item = nodeAttributeMap.get(node);
                        item.count++;
                        // å±æ€§å€¤ã‚’è¿½åŠ ï¼ˆé‡è¤‡ã‚’ä¿æŒï¼‰
                        attrColumns.forEach(attrCol => {
                            const value = row[attrCol];
                            if (value === undefined || value === null) {
                                item[`${attrCol}_values`].push(' ');
                            } else if (value === '') {
                                item[`${attrCol}_values`].push(' ');
                            } else {
                                item[`${attrCol}_values`].push(String(value));
                            }
                        });
                    }
                });
            });

            const nodeAttributeList = Array.from(nodeAttributeMap.values()).map(item => {
                const result = {
                    Node: item.Node
                };
                // é…åˆ—ã‚’æ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆé‡è¤‡ã‚’ä¿æŒï¼‰
                attrColumns.forEach(col => {
                    result[col] = item[`${col}_values`].join('|');
                });
                result.NodeWeight = item.count;
                return result;
            });

            generatedFiles['Node.csv'] = {
                data: nodeAttributeList,
                description: 'ãƒãƒ¼ãƒ‰å±æ€§ãƒ†ãƒ¼ãƒ–ãƒ«'
            };
            log(`å®Œäº†: Node.csv ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆ${nodeAttributeList.length} ãƒãƒ¼ãƒ‰ï¼‰`, 'success');

            // 4. Node with classification.csv ã®ä½œæˆ
            log('å‡¦ç†ä¸­: Node with classificationã‚’ä½œæˆã—ã¦ã„ã¾ã™...', 'info');
            const nodeTypeMap = new Map();

            nodeColumns.forEach(col => {
                loadedData.forEach(row => {
                    const node = row[col];
                    if (node && !nodeTypeMap.has(node)) {
                        nodeTypeMap.set(node, {
                            Node: node,
                            NodeClass: col  // ã‚«ãƒ©ãƒ åã‚’ã‚«ãƒ†ã‚´ãƒªåã¨ã—ã¦ä½¿ç”¨
                        });
                    }
                });
            });

            const nodeTypeList = Array.from(nodeTypeMap.values());

            generatedFiles['Node with classification.csv'] = {
                data: nodeTypeList,
                description: 'ãƒãƒ¼ãƒ‰åˆ†é¡ãƒ†ãƒ¼ãƒ–ãƒ«'
            };
            log(`å®Œäº†: Node with classification.csv ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆ${nodeTypeList.length} ãƒãƒ¼ãƒ‰ï¼‰`, 'success');

            log('ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');

            // çµæœã®è¡¨ç¤º
            displayResults();
        }

        // çµæœè¡¨ç¤ºé–¢æ•°
        function displayResults() {
            resultsCard.classList.remove('hidden');

            // çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
            resultsGrid.innerHTML = '';
            const stats = [
                { label: 'Network.csv', count: generatedFiles['Network.csv'].data.length, unit: 'ã‚¨ãƒƒã‚¸' },
                { label: 'Network with weight.csv', count: generatedFiles['Network with weight.csv'].data.length, unit: 'ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¨ãƒƒã‚¸' },
                { label: 'Node.csv', count: generatedFiles['Node.csv'].data.length, unit: 'ãƒãƒ¼ãƒ‰' },
                { label: 'Node with classification.csv', count: generatedFiles['Node with classification.csv'].data.length, unit: 'ãƒãƒ¼ãƒ‰' }
            ];

            stats.forEach(stat => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <h3>${stat.label}</h3>
                    <div class="count">${stat.count.toLocaleString()}</div>
                    <div class="unit">${stat.unit}</div>
                `;
                resultsGrid.appendChild(item);
            });

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã®è¡¨ç¤º
            previewTabs.innerHTML = '';
            let isFirst = true;
            Object.keys(generatedFiles).forEach(fileName => {
                const tab = document.createElement('button');
                tab.className = `preview-tab ${isFirst ? 'active' : ''}`;
                tab.textContent = fileName.replace('.csv', '');
                tab.onclick = () => showPreview(fileName, tab);
                previewTabs.appendChild(tab);
                if (isFirst) {
                    showPreview(fileName, tab);
                    isFirst = false;
                }
            });

            // çµæœã‚«ãƒ¼ãƒ‰ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            resultsCard.scrollIntoView({ behavior: 'smooth' });
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºé–¢æ•°
        function showPreview(fileName, tab) {
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            const data = generatedFiles[fileName].data;
            if (!data || data.length === 0) {
                previewTable.innerHTML = '<tr><td>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            const headers = Object.keys(data[0]);
            let headerRow = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

            // ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆæœ€åˆã®10è¡Œã®ã¿è¡¨ç¤ºï¼‰
            const previewData = data.slice(0, 10);
            let dataRows = previewData.map(row => {
                return '<tr>' + headers.map(h => {
                    let value = row[h];
                    if (typeof value === 'string' && value.length > 50) {
                        value = value.substring(0, 47) + '...';
                    }
                    return `<td>${value !== undefined && value !== null ? value : ''}</td>`;
                }).join('') + '</tr>';
            }).join('');

            if (data.length > 10) {
                dataRows += `<tr><td colspan="${headers.length}" style="text-align: center; color: #666;">... ä»– ${data.length - 10} è¡Œ</td></tr>`;
            }

            previewTable.innerHTML = headerRow + dataRows;
        }

        // ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ä¸€æ‹¬ä¿å­˜
        async function saveAllToFolder() {
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.className = 'save-status';
            saveStatus.style.display = 'none';

            // File System Access APIã®ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
            if (!('showDirectoryPicker' in window)) {
                saveStatus.className = 'save-status error';
                saveStatus.innerHTML = 'âš ï¸ ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚©ãƒ«ãƒ€é¸æŠæ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚<br>Chromeã€Edgeã€ã¾ãŸã¯Operaã‚’ãŠä½¿ã„ãã ã•ã„ã€‚';
                return;
            }

            try {
                // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                const dirHandle = await window.showDirectoryPicker({
                    mode: 'readwrite'
                });

                let savedCount = 0;
                const totalFiles = Object.keys(generatedFiles).length;

                // å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
                for (const fileName of Object.keys(generatedFiles)) {
                    const fileData = generatedFiles[fileName];
                    const data = fileData.data;

                    if (!data || data.length === 0) {
                        log(`ã‚¹ã‚­ãƒƒãƒ—: ${fileName} ã®ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚`, 'warning');
                        continue;
                    }

                        // CSVå½¢å¼ã§ä¿å­˜ï¼ˆå„å€¤ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã‚€ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
                        const headers = Object.keys(data[0]);

                        function escapeCsv(val) {
                            const text = String(val !== undefined && val !== null ? val : '');
                            return '"' + text.replace(/"/g, '""') + '"';
                        }

                        const lines = [];
                        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                        lines.push(headers.map(h => escapeCsv(h)).join(','));

                        // ãƒ‡ãƒ¼ã‚¿è¡Œ
                        data.forEach(row => {
                            const rowVals = headers.map(h => escapeCsv(row[h]));
                            lines.push(rowVals.join(','));
                        });

                        // UTF-8 BOM ã‚’ä»˜ä¸ã—ã¦ Excel äº’æ›æ€§ã‚’ç¢ºä¿
                        const csvContent = '\uFEFF' + lines.join('\r\n');

                        const csvFileName = fileName.endsWith('.csv') ? fileName : fileName.replace(/\.xlsx$/i, '.csv');
                        const fileHandle = await dirHandle.getFileHandle(csvFileName, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
                        await writable.close();

                        savedCount++;
                        log(`${csvFileName} ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`, 'success');
                }

                saveStatus.className = 'save-status success';
                saveStatus.innerHTML = `âœ… ${savedCount}/${totalFiles} ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`;
                log(`ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ« (${savedCount}ä»¶) ã‚’é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã—ã¾ã—ãŸã€‚`, 'success');

            } catch (err) {
                if (err.name === 'AbortError') {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆ
                    log('ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚', 'info');
                    return;
                }
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                saveStatus.className = 'save-status error';
                saveStatus.innerHTML = `âŒ ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`;
                log(`ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            }
        }
    </script>
</body>
</html>
